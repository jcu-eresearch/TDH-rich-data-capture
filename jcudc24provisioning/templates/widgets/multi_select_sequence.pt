<!--
    multi_select_sequence is a template for a mapping_schema that conditionally outputs fields based on the selected option
    in a standard select box.  The items to be selected from are the mapping_schema's children.

    This template is based directly off the sequence.pt (after modifications - see the modified sequence.pt for details)
-->

<div class="deformSeq"
     id="${field.oid}"
     tal:define="rndr field.renderer;
                 item_tmpl field.widget.item_template;
                 min_len field.widget.min_len or 0;
                 max_len field.widget.max_len or 100000;
                 now_len len(subfields);
                 prototype field.widget.prototype(field)">

    <!-- sequence -->

    <input type="hidden" name="__start__" value="${field.name}:sequence"
           class="deformProto"
           tal:attributes="prototype prototype"/>

    <ul id="seq_items-${field.oid}">

        <div tal:repeat="tup subfields"
             tal:replace="structure rndr(item_tmpl, field=tup[1], cstruct=tup[0],
                      parent=field)"/>

    <span class="deformInsertBefore"
          tal:attributes="min_len min_len; 
                          max_len max_len; 
                          now_len now_len"></span>

    </ul>

    <hr/>

    <select class="first_field half_width">
        <option tal:repeat="(key) field.schema.__dict__['children'][0].data"
                tal:attributes="selected key == cstruct and 'selected';
                         class field.widget.css_class"
                value="${key}">${key}
        </option>
    </select>
    <br/>
    <select class="second_field half_width"></select>
    <br/>
    <select class="third_field half_width"></select>

    <div id="second_level_data" class="hidden">
            <span tal:repeat="(key, values) field.schema.__dict__['children'][0].data.items()"
                  tal:attributes="class 'second_level_data-'+key">
                <option tal:repeat="(second_key) values"
                        tal:attributes="selected second_key == cstruct and 'selected';
                         class field.widget.css_class"
                        value="${second_key}">${second_key}
                </option>
            </span>
    </div>
    <div id="third_level_data" class="hidden">
            <span tal:repeat="(key, values) field.schema.__dict__['children'][0].data.items()">
                <span tal:repeat="(second_key, second_values) values.items()"
                      tal:attributes="class 'third_level_data-'+second_key">
                    <option tal:repeat="(third_key) second_values"
                            tal:attributes="selected third_key == cstruct and 'selected';
                             class field.widget.css_class"
                            value="${third_key}">${third_key}
                    </option>
                </span>
            </span>
    </div>


    <button type="button"
            class="deformSeqAdd"
            id="${field.oid}-seqAdd"
            onclick="deform.appendSequenceItem(this); buttonPressed(this);">
        <small id="${field.oid}-addtext">${add_subitem_text}</small>
    </button>
    <script type="text/javascript">
        deform.addCallback(
                        '${field.oid}',
                        function (oid) {
                            oid_node = $('#' + oid);
                            deform.processSequenceButtons(oid_node, ${min_len},
                                    ${max_len}, ${now_len});
                        }
                )

        deform.addCallback(
                '${field.oid}',
                function (oid) {
                    oid_node = $('#' + oid);

                    showAdd(oid, false);

                    var first_select = oid_node.children(".first_field")[0];
                    var second_select = oid_node.children(".second_field")[0];
                    var third_select = oid_node.children(".third_field")[0];

                    first_select.onchange = function () {
                        updateSecondFields(oid);
                    };
                    second_select.onchange = function () {
                        updateThirdFields(oid);
                        showAdd(oid, false);
                    };
                    third_select.onchange = function () {
                        showAdd(oid, true);
                    };
                }
        )

        function buttonPressed(node) {
            var oid_node = $(node).parent();

            var first_select = oid_node.children(".first_field")[0];
            var second_select = oid_node.children(".second_field")[0];
            var third_select = oid_node.children(".third_field")[0];

            var fields = oid_node.children('ul').first().find("input");
            var text = third_select.options[third_select.selectedIndex].value;
            fields[fields.length - 1].value = text;

            /* Delete duplicates */
            var i = 0;
            for (i; i < fields.length - 1; i++) {
                if (fields[i].value == text) {
                    deform.removeSequenceItem(fields[i]);
                }
            }

            /* Reset the FOR field select boxes */
            first_select.selectedIndex = 0;
            second_select.innerHTML = "";
            third_select.innerHTML = "";
        }

        function showAdd(oid, show) {
            oid_node = $('#' + oid);

            if (show) {
                oid_node.children("button")[0].style.display = "inline";
            } else {
                oid_node.children("button")[0].style.display = "none";
            }
        }

        function updateSecondFields(oid) {
            oid_node = $('#' + oid);

            var first_select = oid_node.children(".first_field")[0];
            var second_select = oid_node.children(".second_field")[0];
            var third_select = oid_node.children(".third_field")[0];

            if (first_select.selectedIndex != 0) {
                var options_class = "second_level_data-" + first_select.options[first_select.selectedIndex].value;
                var second_level_options = document.getElementsByClassName(options_class)[0];
                second_select.innerHTML = second_level_options.innerHTML;
            } else {
                second_select.innerHTML = "";
                first_select.selectedIndex = 0;
            }

            third_select.innerHTML = ""; /* Make sure that the user can't have an invalid 3rd field selected when the first select is changed */
            showAdd(oid, false);
        }

        function updateThirdFields(oid) {
            oid_node = $('#' + oid);

            var first_select = oid_node.children(".first_field")[0];
            var second_select = oid_node.children(".second_field")[0];
            var third_select = oid_node.children(".third_field")[0];

            if (second_select.selectedIndex != 0) {
                var options_class = "third_level_data-" + second_select.options[second_select.selectedIndex].value;
                var third_level_options = document.getElementsByClassName(options_class)[0];
                third_select.innerHTML = third_level_options.innerHTML;
            } else {
                third_select.innerHTML = "";
            }
        }
    </script>
    <script type="text/javascript">
    </script>

    <input type="hidden" name="__end__" value="${field.name}:sequence"/>

    <!-- /sequence -->

</div>
